import { useToast } from '@/components/ui/use-toast';
import geminiDashboardService, { getAISuggestion, generateContent } from './geminiDashboardService';

/**
 * Servicio de IA para generaci칩n autom치tica de actividades
 * Analiza diagn칩sticos y genera planes de apoyo personalizados usando Gemini AI
 */

// Configuraci칩n de IA
const AI_CONFIG = {
  // Simular delay de IA (en producci칩n ser칤a una llamada real a IA)
  PROCESSING_DELAY: 2000,
  
  // Niveles de complejidad de actividades
  COMPLEXITY_LEVELS: {
    beginner: { minDuration: 5, maxDuration: 15, strategies: 2 },
    intermediate: { minDuration: 10, maxDuration: 25, strategies: 3 },
    advanced: { minDuration: 20, maxDuration: 40, strategies: 4 }
  },
  
  // Tipos de actividades por necesidad
  ACTIVITY_TYPES: {
    reading_support: {
      primary: 'reading_comprehension',
      secondary: ['visual_learning', 'attention_training'],
      materials: ['textos adaptados', 'im치genes', 'preguntas guiadas'],
      adaptations: ['tiempo extendido', 'apoyo visual', 'instrucciones claras']
    },
    attention_management: {
      primary: 'attention_training',
      secondary: ['focus_exercises', 'mindfulness'],
      materials: ['timer', 'actividades cortas', 'sistema de recompensas'],
      adaptations: ['descansos frecuentes', 'refuerzo positivo', 'nivel ajustable']
    },
    peer_interaction: {
      primary: 'social_skills',
      secondary: ['communication', 'teamwork'],
      materials: ['gu칤as de interacci칩n', 'roles claros', 'facilitador'],
      adaptations: ['trabajo en parejas', 'roles espec칤ficos', 'apoyo del profesor']
    },
    emotional_regulation: {
      primary: 'emotional_management',
      secondary: ['self_awareness', 'coping_strategies'],
      materials: ['emocion칩metro', 't칠cnicas de respiraci칩n', 'diario emocional'],
      adaptations: ['espacio seguro', 'tiempo de reflexi칩n', 'apoyo emocional']
    },
    math_difficulties: {
      primary: 'mathematical_thinking',
      secondary: ['problem_solving', 'logical_reasoning'],
      materials: ['manipulativos', 'ejemplos visuales', 'problemas paso a paso'],
      adaptations: ['tiempo extendido', 'ejemplos m칰ltiples', 'verificaci칩n continua']
    }
  }
};

/**
 * Analiza un diagn칩stico de estudiante y genera recomendaciones de IA usando Gemini
 */
const analyzeDiagnosis = async (diagnosticInfo) => {
  console.log('游뱄 Gemini AI: Analizando diagn칩stico del estudiante...', diagnosticInfo);
  
  try {
    // Crear prompt para an치lisis de diagn칩stico
    const prompt = `
Como experto en psicopedagog칤a y an치lisis de diagn칩sticos educativos, analiza el siguiente perfil de estudiante y proporciona un an치lisis detallado:

INFORMACI칍N DEL ESTUDIANTE:
${JSON.stringify(diagnosticInfo, null, 2)}

Por favor, proporciona un an치lisis estructurado que incluya:

1. PERFIL DE APRENDIZAJE:
   - Estilo de aprendizaje predominante
   - Capacidades de atenci칩n y concentraci칩n
   - Nivel acad칠mico actual
   - Fortalezas identificadas

2. NECESIDADES PRIORITARIAS:
   - Necesidades acad칠micas urgentes
   - Necesidades conductuales
   - Necesidades socioemocionales
   - Necesidades de comunicaci칩n

3. ENFOQUES RECOMENDADOS:
   - Estrategias pedag칩gicas m치s efectivas
   - Adaptaciones necesarias
   - Recursos recomendados

4. FACTORES DE RIESGO:
   - 츼reas de preocupaci칩n
   - Posibles dificultades futuras
   - Estrategias de prevenci칩n

5. FORTALEZAS A APROVECHAR:
   - 츼reas de competencia
   - Habilidades desarrolladas
   - Potencial a desarrollar

Responde en formato JSON estructurado para facilitar el procesamiento autom치tico.
`;

    // Llamar a Gemini AI
    const result = await geminiDashboardService.generatePsychopedagogueAnalysis(
      { full_name: 'An치lisis de Diagn칩stico' }, 
      diagnosticInfo, 
      [] // Pasar array vac칤o en lugar de objeto vac칤o
    );
    
    if (result.success) {
      console.log('游뱄 Gemini AI: An치lisis completado exitosamente');
      
      // Parsear la respuesta de Gemini si es JSON
      let aiAnalysis;
      try {
        aiAnalysis = JSON.parse(result.data);
      } catch (parseError) {
        // Si no es JSON v치lido, crear estructura con la respuesta
        aiAnalysis = {
          learningProfile: generateLearningProfile(diagnosticInfo),
          priorityNeeds: identifyPriorityNeeds(diagnosticInfo),
          recommendedApproaches: generateRecommendedApproaches(diagnosticInfo),
          riskFactors: identifyRiskFactors(diagnosticInfo),
          strengths: identifyStrengths(diagnosticInfo),
          aiInsights: result.data
        };
      }
      
      return aiAnalysis;
    } else {
      console.warn('游뱄 Gemini AI: Error en an치lisis, usando fallback');
      // Fallback a an치lisis local si Gemini falla
      return {
        learningProfile: generateLearningProfile(diagnosticInfo),
        priorityNeeds: identifyPriorityNeeds(diagnosticInfo),
        recommendedApproaches: generateRecommendedApproaches(diagnosticInfo),
        riskFactors: identifyRiskFactors(diagnosticInfo),
        strengths: identifyStrengths(diagnosticInfo),
        aiInsights: 'An치lisis generado localmente (IA no disponible)'
      };
    }
  } catch (error) {
    console.error('游뱄 Gemini AI: Error en an치lisis:', error);
    // Fallback a an치lisis local
    return {
      learningProfile: generateLearningProfile(diagnosticInfo),
      priorityNeeds: identifyPriorityNeeds(diagnosticInfo),
      recommendedApproaches: generateRecommendedApproaches(diagnosticInfo),
      riskFactors: identifyRiskFactors(diagnosticInfo),
      strengths: identifyStrengths(diagnosticInfo),
      aiInsights: 'An치lisis generado localmente (Error de IA)'
    };
  }
};

/**
 * Genera actividades personalizadas basadas en el an치lisis de IA usando Gemini
 */
const generatePersonalizedActivities = async (piarData, analysis) => {
  console.log('游뱄 Gemini AI: Generando actividades personalizadas...', { piarData, analysis });
  
  try {
    // Crear prompt para generaci칩n de actividades
    const prompt = `
Eres un especialista en educaci칩n especial con m치s de 20 a침os de experiencia dise침ando intervenciones educativas personalizadas. Tu tarea es crear actividades educativas altamente espec칤ficas y detalladas basadas en evidencia cient칤fica.

DATOS DEL PIAR:
${JSON.stringify(piarData, null, 2)}

AN츼LISIS DE IA:
${JSON.stringify(analysis, null, 2)}

INSTRUCCIONES CR칈TICAS:
1. Cada actividad debe ser espec칤ficamente dise침ada para las necesidades 칰nicas del estudiante
2. Debe incluir adaptaciones concretas y materiales espec칤ficos
3. Debe tener objetivos medibles y criterios de evaluaci칩n claros
4. Debe considerar el nivel de desarrollo y capacidades del estudiante
5. Debe ser implementable en el contexto escolar real
6. Debe estar basada en evidencia cient칤fica y mejores pr치cticas

Genera un conjunto completo de actividades en formato JSON estructurado:

{
  "activities": [
    {
      "id": "ID 칰nico de la actividad",
      "title": "T칤tulo espec칤fico y descriptivo de la actividad",
      "description": "Descripci칩n detallada paso a paso de la actividad",
      "objective": "Objetivo espec칤fico y medible de la actividad",
      "duration": "Duraci칩n en minutos",
      "difficulty": "beginner/intermediate/advanced",
      "priority": "high/medium/low",
      "category": "academic/behavioral/social/emotional/physical",
      "subject": "츼rea acad칠mica espec칤fica",
      "targetNeeds": ["Necesidad espec칤fica 1", "Necesidad espec칤fica 2"],
      "targetGoals": ["Objetivo del PIAR 1", "Objetivo del PIAR 2"],
      "materials": [
        {
          "name": "Nombre espec칤fico del material",
          "description": "Descripci칩n detallada del material",
          "quantity": "Cantidad necesaria",
          "alternative": "Alternativa si no est치 disponible"
        }
      ],
      "adaptations": [
        {
          "type": "visual/auditory/kinesthetic/time/space",
          "description": "Descripci칩n espec칤fica de la adaptaci칩n",
          "rationale": "Por qu칠 es necesaria esta adaptaci칩n",
          "implementation": "C칩mo implementar la adaptaci칩n"
        }
      ],
      "instructions": {
        "preparation": "Pasos espec칤ficos de preparaci칩n",
        "implementation": [
          "Paso 1: Descripci칩n detallada",
          "Paso 2: Descripci칩n detallada",
          "Paso 3: Descripci칩n detallada"
        ],
        "closure": "C칩mo finalizar la actividad",
        "cleanup": "Instrucciones de limpieza"
      },
      "assessment": {
        "criteria": ["Criterio espec칤fico 1", "Criterio espec칤fico 2"],
        "methods": ["M칠todo de evaluaci칩n 1", "M칠todo de evaluaci칩n 2"],
        "tools": ["Herramienta de evaluaci칩n 1", "Herramienta de evaluaci칩n 2"],
        "rubric": {
          "excellent": "Descripci칩n de desempe침o excelente",
          "good": "Descripci칩n de desempe침o bueno",
          "satisfactory": "Descripci칩n de desempe침o satisfactorio",
          "needs_improvement": "Descripci칩n de 치reas de mejora"
        }
      },
      "differentiation": {
        "for_struggling": "C칩mo adaptar para estudiantes con dificultades",
        "for_advanced": "C칩mo extender para estudiantes avanzados",
        "for_different_learning_styles": "Adaptaciones por estilo de aprendizaje"
      },
      "integration": {
        "with_curriculum": "C칩mo se integra con el curr칤culo regular",
        "cross_subject": "Conexiones con otras materias",
        "real_world": "Aplicaciones en la vida real"
      },
      "monitoring": {
        "progress_indicators": ["Indicador 1", "Indicador 2"],
        "data_collection": "C칩mo recopilar datos de progreso",
        "frequency": "Con qu칠 frecuencia evaluar",
        "adjustments": "Cu치ndo y c칩mo hacer ajustes"
      },
      "aiInsights": "An치lisis espec칤fico de c칩mo esta actividad aborda las necesidades del PIAR",
      "evidence": "Base cient칤fica que sustenta esta actividad",
      "variations": [
        {
          "name": "Nombre de la variaci칩n",
          "description": "C칩mo var칤a la actividad",
          "when_to_use": "Cu치ndo usar esta variaci칩n"
        }
      ]
    }
  ]
}

IMPORTANTE: Responde SOLO con el JSON v치lido, sin texto adicional. Genera al menos 5-8 actividades espec칤ficas y detalladas.
`;

    // Llamar directamente a Gemini AI con el prompt mejorado
    const result = await generateContent(prompt);
    
    if (result.success) {
      console.log('游뱄 Gemini AI: Actividades generadas exitosamente');
      
      // Parsear la respuesta de Gemini si es JSON
      let aiActivities;
      try {
        aiActivities = JSON.parse(result.data);
        
        // Asegurar que sea un array
        if (!Array.isArray(aiActivities)) {
          aiActivities = [aiActivities];
        }
        
        // Agregar metadatos de IA
        aiActivities = aiActivities.map((activity, index) => ({
          ...activity,
          id: `gemini-activity-${Date.now()}-${index}`,
          aiGenerated: true,
          generatedBy: 'Gemini AI',
          timestamp: new Date().toISOString()
        }));
        
        return aiActivities;
      } catch (parseError) {
        console.warn('游뱄 Gemini AI: Error parseando actividades, usando fallback');
        // Fallback a generaci칩n local
        return generateFallbackActivities(piarData, analysis);
      }
    } else {
      console.warn('游뱄 Gemini AI: Error generando actividades, usando fallback');
      return generateFallbackActivities(piarData, analysis);
    }
  } catch (error) {
    console.error('游뱄 Gemini AI: Error en generaci칩n de actividades:', error);
    return generateFallbackActivities(piarData, analysis);
  }
};

/**
 * Genera actividades de fallback cuando Gemini no est치 disponible
 */
const generateFallbackActivities = (piarData, analysis) => {
  const activities = [];
  
  // Generar actividades basadas en necesidades espec칤ficas
  if (piarData.specific_needs) {
    for (const need of piarData.specific_needs) {
      const needActivities = generateActivitiesForNeed(need, piarData.diagnostic_info, analysis);
      activities.push(...needActivities);
    }
  }
  
  // Generar actividades basadas en objetivos
  if (piarData.goals) {
    for (const goal of piarData.goals) {
      const goalActivities = generateActivitiesForGoal(goal, piarData.diagnostic_info, analysis);
      activities.push(...goalActivities);
    }
  }
  
  // Generar actividades de refuerzo basadas en fortalezas
  const strengthActivities = generateStrengthBasedActivities(analysis.strengths, piarData.diagnostic_info);
  activities.push(...strengthActivities);
  
  console.log('游뱄 Fallback: Actividades generadas localmente:', activities.length);
  return activities;
};

/**
 * Genera un plan de apoyo autom치tico completo usando Gemini AI
 */
const generateAutoSupportPlan = async (studentData, piarData) => {
  console.log('游뱄 Gemini AI: Generando plan de apoyo autom치tico...', { studentData, piarData });
  
  try {
    // Realizar an치lisis de IA una sola vez
    const aiAnalysis = await analyzeDiagnosis(piarData.diagnostic_info);
    
    // Crear prompt para plan de apoyo completo
    const prompt = `
Eres un psicopedagogo cl칤nico experto con m치s de 20 a침os de experiencia dise침ando planes de apoyo educativo integrales. Tu tarea es crear un plan de apoyo altamente espec칤fico, detallado y basado en evidencia cient칤fica.

DATOS DEL ESTUDIANTE:
${JSON.stringify(studentData, null, 2)}

DATOS DEL PIAR:
${JSON.stringify(piarData, null, 2)}

AN츼LISIS DE IA REALIZADO:
${JSON.stringify(aiAnalysis, null, 2)}

INSTRUCCIONES CR칈TICAS:
1. El plan debe ser altamente espec칤fico y personalizado
2. Debe incluir estrategias basadas en evidencia cient칤fica
3. Debe tener objetivos SMART (espec칤ficos, medibles, alcanzables, relevantes, temporales)
4. Debe considerar el contexto escolar y familiar
5. Debe incluir evaluaciones y seguimiento continuo
6. Debe ser implementable por el equipo educativo

Genera un plan de apoyo integral en formato JSON estructurado:

{
  "summary": "Resumen ejecutivo detallado del plan de apoyo, incluyendo perfil del estudiante, necesidades principales y objetivos prioritarios",
  "implementation": {
    "timeline": {
      "immediate": "Acciones inmediatas espec칤ficas (0-2 semanas) con fechas concretas",
      "shortTerm": "Objetivos espec칤ficos a corto plazo (1-3 meses) con indicadores medibles",
      "longTerm": "Objetivos espec칤ficos a largo plazo (3-12 meses) con metas claras",
      "review": "Fechas espec칤ficas de revisi칩n y evaluaci칩n con criterios de evaluaci칩n"
    },
    "resources": {
      "materials": ["Material espec칤fico 1 con descripci칩n detallada", "Material espec칤fico 2 con especificaciones"],
      "personnel": ["Profesional 1 con responsabilidades espec칤ficas", "Profesional 2 con rol definido"],
      "training": ["Capacitaci칩n espec칤fica 1 con objetivos claros", "Capacitaci칩n espec칤fica 2 con duraci칩n y contenidos"],
      "technology": ["Tecnolog칤a espec칤fica 1 con uso definido", "Tecnolog칤a espec칤fica 2 con capacitaci칩n requerida"]
    },
    "monitoring": {
      "frequency": "Frecuencia espec칤fica de monitoreo (diario/semanal/mensual)",
      "methods": ["M칠todo espec칤fico 1 con protocolo", "M칠todo espec칤fico 2 con criterios"],
      "responsibilities": "Responsabilidades espec칤ficas de cada profesional con horarios y tareas",
      "documentation": "Protocolo espec칤fico de documentaci칩n con formatos y frecuencia"
    }
  },
  "recommendations": [
    {
      "category": "academic/behavioral/social/emotional",
      "title": "Recomendaci칩n espec칤fica con t칤tulo descriptivo",
      "description": "Descripci칩n detallada de la recomendaci칩n con justificaci칩n",
      "rationale": "Por qu칠 es importante esta recomendaci칩n basada en evidencia",
      "implementation": "Pasos espec칤ficos para implementar la recomendaci칩n",
      "timeline": "Cronograma espec칤fico para implementar la recomendaci칩n",
      "expectedOutcome": "Resultado esperado espec칤fico y medible",
      "evaluation": "C칩mo se evaluar치 el 칠xito de esta recomendaci칩n"
    }
  ],
  "successMetrics": {
    "academic": ["M칠trica acad칠mica espec칤fica 1 con criterios", "M칠trica acad칠mica espec칤fica 2 con indicadores"],
    "behavioral": ["M칠trica conductual espec칤fica 1 con observaciones", "M칠trica conductual espec칤fica 2 con registros"],
    "social": ["M칠trica social espec칤fica 1 con interacciones", "M칠trica social espec칤fica 2 con habilidades"],
    "emotional": ["M칠trica emocional espec칤fica 1 con regulaci칩n", "M칠trica emocional espec칤fica 2 con bienestar"]
  },
  "collaboration": {
    "teamMembers": [
      {
        "role": "Rol espec칤fico",
        "name": "Nombre del profesional",
        "responsibilities": ["Responsabilidad espec칤fica 1", "Responsabilidad espec칤fica 2"],
        "meetingFrequency": "Frecuencia de reuniones",
        "communicationMethod": "M칠todo de comunicaci칩n preferido"
      }
    ],
    "familyInvolvement": {
      "communication": "Protocolo espec칤fico de comunicaci칩n con la familia",
      "training": "Capacitaci칩n espec칤fica para la familia",
      "support": "Apoyo espec칤fico que la familia puede proporcionar",
      "meetings": "Frecuencia y estructura de reuniones familiares"
    }
  },
  "riskManagement": {
    "potentialRisks": [
      {
        "risk": "Riesgo espec칤fico identificado",
        "probability": "Probabilidad de ocurrencia",
        "impact": "Impacto potencial",
        "mitigation": "Estrategias espec칤ficas de mitigaci칩n",
        "monitoring": "C칩mo monitorear este riesgo"
      }
    ],
    "contingencyPlans": [
      {
        "scenario": "Escenario espec칤fico",
        "response": "Respuesta espec칤fica planificada",
        "resources": "Recursos necesarios para la respuesta",
        "timeline": "Tiempo de respuesta esperado"
      }
    ]
  }
}

IMPORTANTE: Responde SOLO con el JSON v치lido, sin texto adicional. El plan debe ser altamente espec칤fico y detallado.
`;

    // Llamar directamente a Gemini AI con el prompt mejorado
    const result = await generateContent(prompt);
    
    let aiPlan;
    if (result.success) {
      try {
        aiPlan = JSON.parse(result.data);
      } catch (parseError) {
        console.warn('游뱄 Gemini AI: Error parseando plan, usando estructura base');
        aiPlan = {
          summary: result.data,
          implementation: generateTimeline(piarData),
          recommendations: generateResourceRecommendations(piarData)
        };
      }
    } else {
      console.warn('游뱄 Gemini AI: Error generando plan, usando fallback');
      aiPlan = {
        summary: 'Plan generado localmente',
        implementation: generateTimeline(piarData),
        recommendations: generateResourceRecommendations(piarData)
      };
    }
    
    // Generar actividades personalizadas
    const activities = await generatePersonalizedActivities(piarData, aiAnalysis);
    
    const plan = {
      id: `auto-plan-${Date.now()}`,
      title: `Plan de Apoyo Autom치tico - ${studentData.full_name}`,
      description: `Plan generado autom치ticamente por Gemini AI basado en an치lisis de diagn칩stico`,
      generatedAt: new Date().toISOString(),
      studentId: studentData.id,
      studentName: studentData.full_name,
      generatedBy: 'Gemini AI',
      
      // An치lisis de IA
      aiAnalysis: aiAnalysis,
      
      // Plan generado por IA
      aiPlan: aiPlan,
      
      // Actividades generadas
      activities: activities,
      
      // Recomendaciones de implementaci칩n
      implementation: {
        priority: determineImplementationPriority(piarData),
        timeline: generateTimeline(piarData),
        resources: generateResourceRecommendations(piarData),
        monitoring: generateMonitoringPlan(piarData)
      },
      
      // M칠tricas de 칠xito
      successMetrics: generateSuccessMetrics(piarData),
      
      // Pr칩ximos pasos
      nextSteps: generateNextSteps(piarData)
    };
    
    console.log('游뱄 Gemini AI: Plan de apoyo generado exitosamente:', plan);
    return plan;
  } catch (error) {
    console.error('游뱄 Gemini AI: Error generando plan de apoyo:', error);
    
    // Fallback completo
    const aiAnalysis = await analyzeDiagnosis(piarData.diagnostic_info);
    const activities = await generatePersonalizedActivities(piarData, aiAnalysis);
    
    return {
      id: `auto-plan-${Date.now()}`,
      title: `Plan de Apoyo Autom치tico - ${studentData.full_name}`,
      description: `Plan generado localmente (IA no disponible)`,
      generatedAt: new Date().toISOString(),
      studentId: studentData.id,
      studentName: studentData.full_name,
      generatedBy: 'Sistema Local',
      
      aiAnalysis: aiAnalysis,
      activities: activities,
      implementation: {
        priority: determineImplementationPriority(piarData),
        timeline: generateTimeline(piarData),
        resources: generateResourceRecommendations(piarData),
        monitoring: generateMonitoringPlan(piarData)
      },
      successMetrics: generateSuccessMetrics(piarData),
      nextSteps: generateNextSteps(piarData)
    };
  }
};

// Funciones auxiliares para an치lisis de IA

function generateLearningProfile(diagnosticInfo) {
  const profile = {
    style: diagnosticInfo.learning_style,
    attention: diagnosticInfo.attention_span,
    academicLevel: {
      reading: diagnosticInfo.reading_level,
      math: diagnosticInfo.math_level
    },
    social: diagnosticInfo.social_skills,
    emotional: diagnosticInfo.emotional_regulation,
    communication: diagnosticInfo.communication_style
  };
  
  // Agregar insights de IA
  profile.insights = generateLearningInsights(profile);
  profile.recommendations = generateProfileRecommendations(profile);
  
  return profile;
}

function generateLearningInsights(profile) {
  const insights = [];
  
  if (profile.style === 'visual' && profile.attention === 'short') {
    insights.push('Aprendizaje visual con atenci칩n limitada - requiere materiales visuales y actividades cortas');
  }
  
  if (profile.academicLevel.reading === 'basic' && profile.communication === 'verbal_preferred') {
    insights.push('Lectura b치sica con preferencia verbal - combinar apoyo visual con explicaciones orales');
  }
  
  if (profile.social === 'developing' && profile.emotional === 'needs_support') {
    insights.push('Habilidades sociales en desarrollo con necesidades emocionales - requiere apoyo socioemocional integrado');
  }
  
  return insights;
}

function generateProfileRecommendations(profile) {
  const recommendations = [];
  
  // Recomendaciones basadas en estilo de aprendizaje
  if (profile.style === 'visual') {
    recommendations.push('Usar diagramas, im치genes y mapas conceptuales');
    recommendations.push('Incorporar colores y elementos visuales en las actividades');
  } else if (profile.style === 'kinesthetic') {
    recommendations.push('Incluir actividades manipulativas y movimiento');
    recommendations.push('Usar materiales concretos y experiencias pr치cticas');
  }
  
  // Recomendaciones basadas en capacidad de atenci칩n
  if (profile.attention === 'short') {
    recommendations.push('Dividir actividades en segmentos de 5-10 minutos');
    recommendations.push('Incluir descansos frecuentes y cambios de actividad');
  }
  
  return recommendations;
}

function identifyPriorityNeeds(diagnosticInfo) {
  const needs = [];
  
  if (diagnosticInfo.reading_level === 'basic') {
    needs.push({
      category: 'academic',
      need: 'reading_support',
      priority: 'high',
      description: 'Necesita apoyo intensivo en lectura'
    });
  }
  
  if (diagnosticInfo.attention_span === 'short') {
    needs.push({
      category: 'behavioral',
      need: 'attention_management',
      priority: 'high',
      description: 'Requiere estrategias para mantener la atenci칩n'
    });
  }
  
  if (diagnosticInfo.social_skills === 'developing') {
    needs.push({
      category: 'social',
      need: 'peer_interaction',
      priority: 'medium',
      description: 'Necesita apoyo para interacci칩n social'
    });
  }
  
  return needs.sort((a, b) => {
    const priorityOrder = { high: 3, medium: 2, low: 1 };
    return priorityOrder[b.priority] - priorityOrder[a.priority];
  });
}

function generateRecommendedApproaches(diagnosticInfo) {
  const approaches = [];
  
  // Enfoque multisensorial si hay dificultades
  if (diagnosticInfo.reading_level === 'basic' || diagnosticInfo.math_level === 'basic') {
    approaches.push({
      name: 'Enfoque Multisensorial',
      description: 'Integrar visual, auditivo y kinest칠sico',
      effectiveness: 'high',
      implementation: 'Usar materiales que involucren m칰ltiples sentidos'
    });
  }
  
  // Enfoque de apoyo emocional
  if (diagnosticInfo.emotional_regulation === 'needs_support') {
    approaches.push({
      name: 'Apoyo Socioemocional',
      description: 'Integrar habilidades emocionales en el aprendizaje',
      effectiveness: 'high',
      implementation: 'Incluir actividades de regulaci칩n emocional'
    });
  }
  
  return approaches;
}

function identifyRiskFactors(diagnosticInfo) {
  const risks = [];
  
  if (diagnosticInfo.reading_level === 'basic' && diagnosticInfo.attention_span === 'short') {
    risks.push({
      factor: 'Doble dificultad acad칠mica',
      level: 'high',
      description: 'Combinaci칩n de lectura b치sica y atenci칩n limitada',
      mitigation: 'Apoyo intensivo y actividades adaptadas'
    });
  }
  
  if (diagnosticInfo.social_skills === 'developing' && diagnosticInfo.emotional_regulation === 'needs_support') {
    risks.push({
      factor: 'Aislamiento social',
      level: 'medium',
      description: 'Riesgo de aislamiento por dificultades sociales y emocionales',
      mitigation: 'Intervenci칩n socioemocional temprana'
    });
  }
  
  return risks;
}

function identifyStrengths(diagnosticInfo) {
  const strengths = [];
  
  if (diagnosticInfo.communication_style === 'verbal_preferred') {
    strengths.push({
      area: 'Comunicaci칩n Verbal',
      description: 'Prefiere comunicaci칩n oral',
      utilization: 'Usar explicaciones verbales y discusiones'
    });
  }
  
  if (diagnosticInfo.learning_style === 'visual') {
    strengths.push({
      area: 'Aprendizaje Visual',
      description: 'Aprende mejor con elementos visuales',
      utilization: 'Incorporar gr치ficos, diagramas y materiales visuales'
    });
  }
  
  return strengths;
}

function generateActivitiesForNeed(need, diagnosticInfo, analysis) {
  const activities = [];
  const activityConfig = AI_CONFIG.ACTIVITY_TYPES[need.need];
  
  if (!activityConfig) return activities;
  
  // Generar actividad principal
  activities.push({
    id: `activity-${need.need}-${Date.now()}`,
    type: activityConfig.primary,
    title: `Actividad de ${need.category}`,
    description: `Actividad personalizada para ${need.description}`,
    duration: getOptimalDuration(diagnosticInfo.attention_span),
    difficulty: determineDifficulty(diagnosticInfo),
    materials: activityConfig.materials,
    adaptations: activityConfig.adaptations,
    based_on_need: need.need,
    priority: need.priority,
    aiGenerated: true,
    aiInsights: generateActivityInsights(need, diagnosticInfo)
  });
  
  // Generar actividad secundaria si es necesario
  if (need.priority === 'high' && activityConfig.secondary) {
    activities.push({
      id: `activity-${need.need}-secondary-${Date.now()}`,
      type: activityConfig.secondary[0],
      title: `Refuerzo de ${need.category}`,
      description: `Actividad complementaria para fortalecer ${need.description}`,
      duration: Math.floor(getOptimalDuration(diagnosticInfo.attention_span) * 0.7),
      difficulty: 'beginner',
      materials: activityConfig.materials.slice(0, 2),
      adaptations: activityConfig.adaptations.slice(0, 2),
      based_on_need: need.need,
      priority: 'medium',
      aiGenerated: true,
      aiInsights: `Refuerzo autom치tico generado para ${need.description}`
    });
  }
  
  return activities;
}

function generateActivitiesForGoal(goal, diagnosticInfo, analysis) {
  const activities = [];
  
  activities.push({
    id: `goal-activity-${goal.id}-${Date.now()}`,
    type: 'goal_oriented',
    title: `Actividad para: ${goal.description}`,
    description: `Actividad espec칤fica para alcanzar el objetivo "${goal.description}"`,
    duration: getOptimalDuration(diagnosticInfo.attention_span),
    difficulty: determineDifficulty(diagnosticInfo),
    materials: ['materiales espec칤ficos del objetivo', 'herramientas de seguimiento'],
    adaptations: ['adaptaciones seg칰n necesidad', 'apoyo personalizado'],
    based_on_goal: goal.id,
    targetDate: goal.target_date,
    currentProgress: goal.progress,
    aiGenerated: true,
    aiInsights: `Actividad generada para alcanzar ${goal.progress}% de progreso hacia el objetivo`
  });
  
  return activities;
}

function generateStrengthBasedActivities(strengths, diagnosticInfo) {
  const activities = [];
  
  for (const strength of strengths) {
    activities.push({
      id: `strength-${strength.area.toLowerCase().replace(' ', '-')}-${Date.now()}`,
      type: 'strength_building',
      title: `Fortalecer: ${strength.area}`,
      description: `Actividad para desarrollar y aprovechar ${strength.description}`,
      duration: getOptimalDuration(diagnosticInfo.attention_span),
      difficulty: 'intermediate',
      materials: ['materiales para fortalecer fortalezas'],
      adaptations: ['adaptaciones para maximizar potencial'],
      based_on_strength: strength.area,
      aiGenerated: true,
      aiInsights: `Actividad dise침ada para maximizar ${strength.description}`
    });
  }
  
  return activities;
}

function getOptimalDuration(attentionSpan) {
  const durationMap = {
    short: 10,
    medium: 20,
    long: 30
  };
  return durationMap[attentionSpan] || 15;
}

function determineDifficulty(diagnosticInfo) {
  if (diagnosticInfo.reading_level === 'basic' || diagnosticInfo.math_level === 'basic') {
    return 'beginner';
  } else if (diagnosticInfo.reading_level === 'advanced' || diagnosticInfo.math_level === 'advanced') {
    return 'advanced';
  }
  return 'intermediate';
}

function generateActivityInsights(need, diagnosticInfo) {
  return `Actividad generada autom치ticamente basada en an치lisis de ${need.category}. Prioridad: ${need.priority}. Duraci칩n optimizada para capacidad de atenci칩n ${diagnosticInfo.attention_span}.`;
}

function determineImplementationPriority(piarData) {
  const highPriorityNeeds = piarData.specific_needs?.filter(n => n.priority === 'high') || [];
  return highPriorityNeeds.length > 0 ? 'high' : 'medium';
}

function generateTimeline(piarData) {
  return {
    immediate: 'Pr칩ximas 2 semanas',
    shortTerm: '1-2 meses',
    longTerm: '3-6 meses',
    review: 'Revisi칩n mensual recomendada'
  };
}

function generateResourceRecommendations(piarData) {
  return {
    materials: ['Materiales adaptados seg칰n necesidades espec칤ficas'],
    personnel: ['Apoyo del psicopedagogo', 'Colaboraci칩n con profesores'],
    technology: ['Herramientas de seguimiento digital', 'Recursos multimedia'],
    environment: ['Espacios adaptados seg칰n necesidades']
  };
}

function generateMonitoringPlan(piarData) {
  return {
    frequency: 'Semanal',
    metrics: ['Progreso en objetivos', 'Participaci칩n', 'Satisfacci칩n'],
    tools: ['Registro de observaciones', 'Evaluaciones adaptadas'],
    adjustments: 'Revisi칩n y ajuste seg칰n progreso'
  };
}

function generateSuccessMetrics(piarData) {
  return {
    academic: ['Mejora en niveles de lectura/matem치ticas', 'Cumplimiento de objetivos'],
    behavioral: ['Mejora en atenci칩n', 'Reducci칩n de comportamientos disruptivos'],
    social: ['Mejora en interacci칩n con pares', 'Participaci칩n en actividades grupales'],
    emotional: ['Mejor regulaci칩n emocional', 'Aumento de autoestima']
  };
}

function generateNextSteps(piarData) {
  return [
    'Implementar actividades prioritarias',
    'Establecer rutina de seguimiento',
    'Coordinar con equipo educativo',
    'Comunicar progreso a familia',
    'Planificar revisi칩n y ajustes'
  ];
}

// Export named exports
export {
  analyzeDiagnosis,
  generatePersonalizedActivities,
  generateAutoSupportPlan
};

// Export default
export default {
  analyzeDiagnosis,
  generatePersonalizedActivities,
  generateAutoSupportPlan
};
